<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocol Guardians KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        Chart.register(ChartDataLabels);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .loading {
            text-align: center;
            font-size: 18px;
            padding: 20px;
            color: #fff;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .kpi-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .kpi-label {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.4);
            padding-bottom: 8px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }
        
        th, td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        th {
            background: rgba(30, 41, 59, 0.9);
            font-weight: bold;
            font-size: 12px;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .top-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 6px;
            margin-top: 8px;
        }
        
        .card-item {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 5px;
            padding: 8px;
            font-size: 11px;
            border-left: 3px solid;
        }
        
        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 4px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .stat-bar {
            display: flex;
            align-items: center;
            margin: 2px 0;
        }
        
        .stat-label {
            min-width: 80px;
            font-size: 11px;
        }
        
        .stat-value {
            flex: 1;
            height: 8px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0ea5e9);
        }
        
        .numerical {
            font-weight: bold;
            color: #00d4ff;
        }
        
        .top-card-name {
            font-weight: bold;
            font-size: 12px;
            color: #00d4ff;
            margin-bottom: 3px;
        }
        
        .two-cols {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .two-cols {
                grid-template-columns: 1fr;
            }
        }
        
        .ability-item {
            display: flex;
            justify-content: space-between;
            padding: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
        }
        
        .ability-name {
            flex: 1;
        }
        
        .ability-stats {
            display: flex;
            gap: 12px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Protocol Guardians KPI Dashboard üõ°Ô∏è</h1>
        
        <div id="loading" class="loading">Loading metadata files...</div>
        
        <div id="content" style="display: none;">
            <!-- Overview KPIs -->
            <div class="section">
                <div class="section-title">üìä Overview</div>
                <div class="kpi-grid" id="overview-kpis"></div>
            </div>
            
            <!-- Distribution Charts -->
            <div class="section">
                <div class="section-title">üìà Distribution Analysis</div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="familyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="rarityChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Combinations Chart -->
            <div class="section">
                <div class="section-title">üîó Type + Family + Rarity Combinations</div>
                <div style="height: 350px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                    <canvas id="combinationsChart"></canvas>
                </div>
            </div>
            
            <!-- Detailed Tables -->
            <div class="section">
                <div class="section-title">üìã Type Analysis</div>
                <div id="type-table"></div>
            </div>
            
            <div class="section">
                <div class="section-title">üë• Family Analysis</div>
                <div id="family-table"></div>
            </div>
            
            <div class="section">
                <div class="section-title">üíé Rarity Analysis</div>
                <div id="rarity-table"></div>
            </div>
            
            <!-- Stats Analysis -->
            <div class="section">
                <div class="section-title">üìä Stats Analysis</div>
                <div class="two-cols">
                    <div>
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Overall Stats Average</h3>
                        <div id="overall-stats"></div>
                    </div>
                    <div>
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Stats by Rarity</h3>
                        <div id="rarity-stats-table"></div>
                    </div>
                </div>
            </div>
            
            <!-- Top Performers -->
            <div class="section">
                <div class="section-title">üèÜ Top 10 Cards by Total Power Level</div>
                <div id="top-performers"></div>
            </div>
            
            <!-- Abilities Analysis -->
            <div class="section">
                <div class="section-title">‚öîÔ∏è Abilities Analysis</div>
                <div id="abilities-analysis"></div>
            </div>
        </div>
    </div>
    
    <script>
        let allCards = [];
        const totalFiles = 533;
        
        async function loadAllMetadata() {
            const promises = [];
            
            for (let i = 1; i <= totalFiles; i++) {
                const numStr = i.toString().padStart(3, '0');
                const fileName = `${numStr}-protocol-guardians.json`;
                const url = `./metadata/json/${fileName}`;
                
                promises.push(
                    fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            data.cardIndex = i;
                            return data;
                        })
                        .catch(err => {
                            console.warn(`Failed to load ${fileName}:`, err);
                            return null;
                        })
                );
            }
            
            const results = await Promise.all(promises);
            allCards = results.filter(card => card !== null);
            
            console.log(`Loaded ${allCards.length} cards`);
            processData();
        }
        
        function processData() {
            const stats = getAllStats();
            const types = getTypeData();
            const families = getFamilyData();
            const rarities = getRarityData();
            const combinations = getCombinations();
            const abilities = getAbilitiesData();
            
            displayOverview(stats);
            displayTypeTable(types);
            displayFamilyTable(families);
            displayRarityTable(rarities);
            displayOverallStats();
            displayTopPerformers();
            displayAbilitiesAnalysis(abilities);
            
            createDistributionCharts(types, families, rarities);
            createCombinationsChart(combinations);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
        
        function getAllStats() {
            const stats = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
            const totals = {};
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const statsObj = {};
                
                attrs.forEach(attr => {
                    if (stats.includes(attr.trait_type)) {
                        statsObj[attr.trait_type] = attr.value;
                    }
                });
                
                stats.forEach(stat => {
                    if (!totals[stat]) {
                        totals[stat] = { sum: 0, count: 0 };
                    }
                    if (statsObj[stat]) {
                        totals[stat].sum += statsObj[stat];
                        totals[stat].count++;
                    }
                });
            });
            
            const averages = {};
            stats.forEach(stat => {
                if (totals[stat]) {
                    averages[stat] = totals[stat].sum / totals[stat].count;
                }
            });
            
            return { totals, averages, stats };
        }
        
        function getTypeData() {
            const typeMap = {};
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const typeAttr = attrs.find(a => a.trait_type === 'Type');
                if (!typeAttr) return;
                
                const type = typeAttr.value.replace(/[ü¶Åü§ñ‚≠êüíÄ‚òÑÔ∏è]/g, '').trim();
                
                if (!typeMap[type]) {
                    typeMap[type] = {
                        count: 0,
                        cards: [],
                        stats: { Power: [], Defense: [], Speed: [], HP: [], Luck: [], Mana: [], Stamina: [], Critical: [] }
                    };
                }
                
                typeMap[type].count++;
                typeMap[type].cards.push(card);
                
                const stats = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
                stats.forEach(stat => {
                    const attr = attrs.find(a => a.trait_type === stat);
                    if (attr) typeMap[type].stats[stat].push(attr.value);
                });
            });
            
            Object.keys(typeMap).forEach(type => {
                const stats = typeMap[type].stats;
                typeMap[type].avgStats = {};
                Object.keys(stats).forEach(stat => {
                    if (stats[stat].length > 0) {
                        typeMap[type].avgStats[stat] = stats[stat].reduce((a, b) => a + b, 0) / stats[stat].length;
                    }
                });
            });
            
            return typeMap;
        }
        
        function getFamilyData() {
            const familyMap = {};
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const familyAttr = attrs.find(a => a.trait_type === 'Family');
                if (!familyAttr) return;
                
                const family = familyAttr.value;
                
                if (!familyMap[family]) {
                    familyMap[family] = {
                        count: 0,
                        cards: [],
                        stats: { Power: [], Defense: [], Speed: [], HP: [], Luck: [], Mana: [], Stamina: [], Critical: [] },
                        bgColors: []
                    };
                }
                
                familyMap[family].count++;
                familyMap[family].cards.push(card);
                if (card.background_color) {
                    familyMap[family].bgColors.push(card.background_color);
                }
                
                const stats = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
                stats.forEach(stat => {
                    const attr = attrs.find(a => a.trait_type === stat);
                    if (attr) familyMap[family].stats[stat].push(attr.value);
                });
            });
            
            Object.keys(familyMap).forEach(family => {
                const stats = familyMap[family].stats;
                familyMap[family].avgStats = {};
                Object.keys(stats).forEach(stat => {
                    if (stats[stat].length > 0) {
                        familyMap[family].avgStats[stat] = stats[stat].reduce((a, b) => a + b, 0) / stats[stat].length;
                    }
                });
            });
            
            return familyMap;
        }
        
        function getRarityData() {
            const rarityMap = {};
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const rarityAttr = attrs.find(a => a.trait_type === 'Rarity');
                if (!rarityAttr) return;
                
                const rarity = rarityAttr.value;
                
                if (!rarityMap[rarity]) {
                    rarityMap[rarity] = {
                        count: 0,
                        cards: [],
                        stats: { Power: [], Defense: [], Speed: [], HP: [], Luck: [], Mana: [], Stamina: [], Critical: [] }
                    };
                }
                
                rarityMap[rarity].count++;
                rarityMap[rarity].cards.push(card);
                
                const stats = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
                stats.forEach(stat => {
                    const attr = attrs.find(a => a.trait_type === stat);
                    if (attr) rarityMap[rarity].stats[stat].push(attr.value);
                });
            });
            
            Object.keys(rarityMap).forEach(rarity => {
                const stats = rarityMap[rarity].stats;
                rarityMap[rarity].avgStats = {};
                Object.keys(stats).forEach(stat => {
                    if (stats[stat].length > 0) {
                        rarityMap[rarity].avgStats[stat] = stats[stat].reduce((a, b) => a + b, 0) / stats[stat].length;
                    }
                });
            });
            
            return rarityMap;
        }
        
        function getCombinations() {
            const combMap = {};
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const typeAttr = attrs.find(a => a.trait_type === 'Type');
                const familyAttr = attrs.find(a => a.trait_type === 'Family');
                const rarityAttr = attrs.find(a => a.trait_type === 'Rarity');
                
                if (!typeAttr || !familyAttr || !rarityAttr) return;
                
                const type = typeAttr.value.replace(/[ü¶Åü§ñ‚≠êüíÄ‚òÑÔ∏è]/g, '').trim();
                const family = familyAttr.value;
                const rarity = rarityAttr.value;
                const key = `${type} + ${family} + ${rarity}`;
                
                if (!combMap[key]) {
                    combMap[key] = 0;
                }
                combMap[key]++;
            });
            
            return combMap;
        }
        
        function getAbilitiesData() {
            const abilitiesMap = {};
            const effectTypes = { buff: 0, utility: 0, special: 0 };
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const abilityAttrs = attrs.filter(a => a.trait_type.startsWith('Ability:'));
                
                abilityAttrs.forEach(attr => {
                    const abilityName = attr.trait_type.replace('Ability: ', '');
                    
                    if (!abilitiesMap[abilityName]) {
                        abilitiesMap[abilityName] = {
                            count: 0,
                            values: [],
                            effectTypes: {},
                            families: {}
                        };
                    }
                    
                    abilitiesMap[abilityName].count++;
                    
                    if (attr.ability_data) {
                        const ad = attr.ability_data;
                        abilitiesMap[abilityName].values.push(ad.value || 0);
                        
                        const effect = ad.effect || 'unknown';
                        abilitiesMap[abilityName].effectTypes[effect] = (abilitiesMap[abilityName].effectTypes[effect] || 0) + 1;
                        effectTypes[effect] = (effectTypes[effect] || 0) + 1;
                        
                        const family = ad.family || 'universal';
                        abilitiesMap[abilityName].families[family] = (abilitiesMap[abilityName].families[family] || 0) + 1;
                    }
                });
            });
            
            Object.keys(abilitiesMap).forEach(ability => {
                const values = abilitiesMap[ability].values;
                if (values.length > 0) {
                    abilitiesMap[ability].avgValue = values.reduce((a, b) => a + b, 0) / values.length;
                }
                
                const mainEffect = Object.keys(abilitiesMap[ability].effectTypes).reduce((a, b) => 
                    abilitiesMap[ability].effectTypes[a] > abilitiesMap[ability].effectTypes[b] ? a : b
                );
                abilitiesMap[ability].mainEffect = mainEffect;
                
                const mainFamily = Object.keys(abilitiesMap[ability].families).reduce((a, b) => 
                    abilitiesMap[ability].families[a] > abilitiesMap[ability].families[b] ? a : b
                );
                abilitiesMap[ability].mainFamily = mainFamily;
            });
            
            return { abilities: abilitiesMap, effectTypes };
        }
        
        function displayOverview(stats) {
            const grid = document.getElementById('overview-kpis');
            const totalCards = allCards.length;
            const uniqueAbilities = new Set();
            
            allCards.forEach(card => {
                const attrs = card.attributes || [];
                const abilities = attrs.filter(a => a.trait_type.startsWith('Ability:'));
                abilities.forEach(a => uniqueAbilities.add(a.trait_type));
            });
            
            const totalPowerLevel = allCards.reduce((sum, card) => {
                const attrs = card.attributes || [];
                const statsArr = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
                const cardTotal = statsArr.reduce((s, stat) => {
                    const attr = attrs.find(a => a.trait_type === stat);
                    return s + (attr ? attr.value : 0);
                }, 0);
                return sum + cardTotal;
            }, 0);
            
            const avgPowerLevel = (totalPowerLevel / totalCards).toFixed(2);
            
            grid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-value">${totalCards}</div>
                    <div class="kpi-label">Total NFTs</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${uniqueAbilities.size}</div>
                    <div class="kpi-label">Unique Abilities</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${avgPowerLevel}</div>
                    <div class="kpi-label">Avg Power Level</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.stats.length}</div>
                    <div class="kpi-label">Stat Types</div>
                </div>
            `;
        }
        
        function displayTypeTable(types) {
            const sortedTypes = Object.keys(types).sort((a, b) => types[b].count - types[a].count);
            const totalCards = allCards.length;
            
            let html = '<table><tr><th>Type</th><th>Count</th><th>%</th><th>Avg Power</th><th>Avg Def</th><th>Avg Speed</th><th>Avg HP</th><th>Top 10 Cards</th></tr>';
            
            sortedTypes.forEach(type => {
                const data = types[type];
                const percentage = ((data.count / totalCards) * 100).toFixed(2);
                
                const top10 = data.cards.slice(0, 10);
                const bgColors = top10.map(c => c.background_color).filter(c => c);
                
                const avgStats = data.avgStats || {};
                const top10Html = top10.map((c, i) => {
                    const color = bgColors[i] ? `<span class="color-indicator" style="background: #${bgColors[i]}"></span>` : '';
                    return `${color}${c.name.substring(0, 30)}`;
                }).join(', ');
                
                html += `<tr>
                    <td>${type}</td>
                    <td class="numerical">${data.count}</td>
                    <td class="numerical">${percentage}%</td>
                    <td class="numerical">${(avgStats.Power || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Defense || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Speed || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.HP || 0).toFixed(2)}</td>
                    <td style="font-size: 8px;">${top10Html || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('type-table').innerHTML = html;
        }
        
        function displayFamilyTable(families) {
            const sortedFamilies = Object.keys(families).sort((a, b) => families[b].count - families[a].count);
            const totalCards = allCards.length;
            
            let html = '<table><tr><th>Family</th><th>Count</th><th>%</th><th>Avg Power</th><th>Avg Def</th><th>Avg Speed</th><th>Avg HP</th><th>Top 10 Cards</th></tr>';
            
            sortedFamilies.forEach(family => {
                const data = families[family];
                const percentage = ((data.count / totalCards) * 100).toFixed(2);
                
                const top10 = data.cards.slice(0, 10);
                const bgColors = top10.map(c => c.background_color).filter(c => c);
                
                const avgStats = data.avgStats || {};
                const top10Html = top10.map((c, i) => {
                    const color = bgColors[i] ? `<span class="color-indicator" style="background: #${bgColors[i]}"></span>` : '';
                    return `${color}${c.name.substring(0, 30)}`;
                }).join(', ');
                
                html += `<tr>
                    <td>${family}</td>
                    <td class="numerical">${data.count}</td>
                    <td class="numerical">${percentage}%</td>
                    <td class="numerical">${(avgStats.Power || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Defense || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Speed || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.HP || 0).toFixed(2)}</td>
                    <td style="font-size: 8px;">${top10Html || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('family-table').innerHTML = html;
        }
        
        function displayRarityTable(rarities) {
            const sortedRarities = Object.keys(rarities).sort((a, b) => rarities[b].count - rarities[a].count);
            const totalCards = allCards.length;
            
            let html = '<table><tr><th>Rarity</th><th>Count</th><th>%</th><th>Avg Power</th><th>Avg Def</th><th>Avg Speed</th><th>Avg HP</th><th>Top 10 Cards</th></tr>';
            
            sortedRarities.forEach(rarity => {
                const data = rarities[rarity];
                const percentage = ((data.count / totalCards) * 100).toFixed(2);
                
                const top10 = data.cards.slice(0, 10);
                const bgColors = top10.map(c => c.background_color).filter(c => c);
                
                const avgStats = data.avgStats || {};
                const top10Html = top10.map((c, i) => {
                    const color = bgColors[i] ? `<span class="color-indicator" style="background: #${bgColors[i]}"></span>` : '';
                    return `${color}${c.name.substring(0, 30)}`;
                }).join(', ');
                
                html += `<tr>
                    <td>${rarity}</td>
                    <td class="numerical">${data.count}</td>
                    <td class="numerical">${percentage}%</td>
                    <td class="numerical">${(avgStats.Power || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Defense || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Speed || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.HP || 0).toFixed(2)}</td>
                    <td style="font-size: 8px;">${top10Html || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('rarity-table').innerHTML = html;
        }
        
        function displayOverallStats() {
            const stats = getAllStats();
            const statsArr = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
            
            let html = '';
            statsArr.forEach(stat => {
                const avg = stats.averages[stat] || 0;
                const max = 3000;
                const percentage = (avg / max) * 100;
                
                html += `<div class="stat-bar">
                    <div class="stat-label">${stat}</div>
                    <div class="stat-value">
                        <div class="stat-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="numerical" style="margin-left: 8px; min-width: 60px;">${avg.toFixed(2)}</div>
                </div>`;
            });
            
            document.getElementById('overall-stats').innerHTML = html;
            
            const rarities = getRarityData();
            const sortedRarities = Object.keys(rarities).sort();
            
            let tableHtml = '<table><tr><th>Rarity</th><th>Power</th><th>Defense</th><th>Speed</th><th>HP</th><th>Luck</th><th>Mana</th><th>Stamina</th><th>Critical</th></tr>';
            
            sortedRarities.forEach(rarity => {
                const avgStats = rarities[rarity].avgStats || {};
                tableHtml += `<tr>
                    <td>${rarity}</td>
                    <td class="numerical">${(avgStats.Power || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Defense || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Speed || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.HP || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Luck || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Mana || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Stamina || 0).toFixed(2)}</td>
                    <td class="numerical">${(avgStats.Critical || 0).toFixed(2)}</td>
                </tr>`;
            });
            
            tableHtml += '</table>';
            document.getElementById('rarity-stats-table').innerHTML = tableHtml;
        }
        
        function displayTopPerformers() {
            const cardScores = allCards.map(card => {
                const attrs = card.attributes || [];
                const stats = ['Power', 'Defense', 'Speed', 'HP', 'Luck', 'Mana', 'Stamina', 'Critical'];
                const statsObj = {};
                
                attrs.forEach(attr => {
                    if (stats.includes(attr.trait_type)) {
                        statsObj[attr.trait_type] = attr.value;
                    }
                });
                
                const total = stats.reduce((sum, stat) => sum + (statsObj[stat] || 0), 0);
                
                return { card, total, statsObj };
            });
            
            const top10 = cardScores.sort((a, b) => b.total - a.total).slice(0, 10);
            
            let html = '<table><tr><th>Rank</th><th>Card Name</th><th>Type</th><th>Family</th><th>Rarity</th><th>Color</th><th>Power</th><th>Def</th><th>Speed</th><th>HP</th><th>Luck</th><th>Mana</th><th>Stam</th><th>Crit</th><th>Total</th></tr>';
            
            top10.forEach((item, index) => {
                const card = item.card;
                const attrs = card.attributes || [];
                const typeAttr = attrs.find(a => a.trait_type === 'Type');
                const familyAttr = attrs.find(a => a.trait_type === 'Family');
                const rarityAttr = attrs.find(a => a.trait_type === 'Rarity');
                
                const type = typeAttr ? typeAttr.value.replace(/[ü¶Åü§ñ‚≠êüíÄ‚òÑÔ∏è]/g, '').trim() : 'N/A';
                const family = familyAttr ? familyAttr.value : 'N/A';
                const rarity = rarityAttr ? rarityAttr.value : 'N/A';
                const colorIndicator = card.background_color ? 
                    `<span class="color-indicator" style="background: #${card.background_color}"></span>` : 'N/A';
                
                html += `<tr>
                    <td class="numerical">${index + 1}</td>
                    <td style="font-size: 8px;">${card.name.substring(0, 40)}</td>
                    <td>${type}</td>
                    <td>${family}</td>
                    <td>${rarity}</td>
                    <td>${colorIndicator}</td>
                    <td class="numerical">${item.statsObj.Power || 0}</td>
                    <td class="numerical">${item.statsObj.Defense || 0}</td>
                    <td class="numerical">${item.statsObj.Speed || 0}</td>
                    <td class="numerical">${item.statsObj.HP || 0}</td>
                    <td class="numerical">${item.statsObj.Luck || 0}</td>
                    <td class="numerical">${item.statsObj.Mana || 0}</td>
                    <td class="numerical">${item.statsObj.Stamina || 0}</td>
                    <td class="numerical">${item.statsObj.Critical || 0}</td>
                    <td class="numerical">${item.total}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('top-performers').innerHTML = html;
        }
        
        function displayAbilitiesAnalysis(abilitiesData) {
            const { abilities, effectTypes } = abilitiesData;
            
            const sortedAbilities = Object.keys(abilities).sort((a, b) => 
                abilities[b].avgValue - abilities[a].avgValue
            );
            
            const top20 = sortedAbilities.slice(0, 20);
            
            let html = '<table><tr><th>Rank</th><th>Ability</th><th>Count</th><th>Avg Value</th><th>Effect</th><th>Family</th></tr>';
            
            top20.forEach((ability, index) => {
                const data = abilities[ability];
                html += `<tr>
                    <td class="numerical">${index + 1}</td>
                    <td style="font-size: 8px;">${ability.substring(0, 40)}</td>
                    <td class="numerical">${data.count}</td>
                    <td class="numerical">${(data.avgValue || 0).toFixed(2)}</td>
                    <td>${data.mainEffect || 'N/A'}</td>
                    <td>${data.mainFamily || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            let effectHtml = '<div style="margin-top: 15px;"><h3 style="font-size: 14px; margin-bottom: 8px;">Abilities by Effect Type</h3>';
            const sortedEffects = Object.keys(effectTypes).sort((a, b) => effectTypes[b] - effectTypes[a]);
            sortedEffects.forEach(effect => {
                const count = effectTypes[effect];
                effectHtml += `<div style="padding: 4px; margin: 3px 0; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; justify-content: space-between;">
                    <span>${effect}</span>
                    <span class="numerical">${count}</span>
                </div>`;
            });
            effectHtml += '</div>';
            
            document.getElementById('abilities-analysis').innerHTML = html + effectHtml;
        }
        
        function createDistributionCharts(types, families, rarities) {
            const colors = {
                type: ['#64748b', '#3b82f6', '#6366f1', '#14b8a6', '#f97316'],
                family: ['#64748b', '#3b82f6', '#6366f1', '#14b8a6', '#f97316', '#eab308', '#8b5cf6', '#ef4444'],
                rarity: ['#64748b', '#3b82f6', '#6366f1', '#14b8a6', '#f97316', '#eab308']
            };
            
            function createPieChart(canvasId, dataObj, labelPrefix) {
                const labels = Object.keys(dataObj);
                const data = Object.values(dataObj).map(item => item.count);
                const bgColors = colors[labelPrefix] || colors.type;
                
                new Chart(document.getElementById(canvasId), {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: bgColors,
                            borderColor: 'rgba(255,255,255,0.5)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#fff',
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return value > total * 0.05 ? `${value}\n(${percentage}%)` : '';
                                }
                            }
                        }
                    }
                });
            }
            
            createPieChart('typeChart', types, 'type');
            createPieChart('familyChart', families, 'family');
            createPieChart('rarityChart', rarities, 'rarity');
        }
        
        function createCombinationsChart(combinations) {
            const sorted = Object.keys(combinations)
                .sort((a, b) => combinations[b] - combinations[a])
                .slice(0, 20);
            
            const labels = sorted.map(comb => comb.substring(0, 50));
            const data = sorted.map(comb => combinations[comb]);
            
            new Chart(document.getElementById('combinationsChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: data,
                        backgroundColor: 'rgba(0, 212, 255, 0.6)',
                        borderColor: '#00d4ff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' cards';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#fff',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        loadAllMetadata();
    </script>
</body>
</html>

